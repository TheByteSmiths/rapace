<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>rapace WebSocket Client Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: #eaeaea;
        }
        h1 {
            color: #00d9ff;
        }
        .section {
            background: #16213e;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            color: #00d9ff;
        }
        button {
            background: #00d9ff;
            color: #1a1a2e;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #00b8d9;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        input {
            background: #0f3460;
            border: 1px solid #00d9ff;
            color: #eaeaea;
            padding: 8px 12px;
            border-radius: 4px;
            width: 80px;
            margin-right: 10px;
        }
        #log {
            background: #0f0f1a;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-info { color: #00d9ff; }
        .log-success { color: #00ff88; }
        .log-error { color: #ff6b6b; }
        .log-stream { color: #ffd93d; }
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }
        .status-connected { background: #00ff88; color: #1a1a2e; }
        .status-disconnected { background: #ff6b6b; color: white; }
        .status-connecting { background: #ffd93d; color: #1a1a2e; }
    </style>
</head>
<body>
    <h1>rapace WebSocket Client Demo</h1>

    <div class="section">
        <h2>Connection <span id="status" class="status status-disconnected">Disconnected</span></h2>
        <button id="connectBtn" onclick="connect()">Connect</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
    </div>

    <div class="section">
        <h2>Adder Service</h2>
        <p>Call <code>add(a, b)</code> to add two numbers.</p>
        <input type="number" id="adderA" value="2" placeholder="a">
        +
        <input type="number" id="adderB" value="3" placeholder="b">
        <button id="adderBtn" onclick="callAdder()" disabled>Call add()</button>
    </div>

    <div class="section">
        <h2>Range Service (Streaming)</h2>
        <p>Call <code>range(n)</code> to stream numbers 0..n.</p>
        <input type="number" id="rangeN" value="5" placeholder="n">
        <button id="rangeBtn" onclick="callRange()" disabled>Call range()</button>
    </div>

    <div class="section">
        <h2>Log</h2>
        <div id="log"></div>
    </div>

    <script type="module">
        import init, { RapaceClient } from './pkg/rapace_wasm_client.js';

        let client = null;

        function log(msg, className = 'log-info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${msg}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setStatus(status) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status;
            statusEl.className = 'status status-' + status.toLowerCase();
        }

        function setButtonsEnabled(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('adderBtn').disabled = !connected;
            document.getElementById('rangeBtn').disabled = !connected;
        }

        window.connect = async function() {
            try {
                setStatus('Connecting');
                log('Initializing WASM module...');
                await init();

                log('Connecting to ws://127.0.0.1:9000...');
                client = await RapaceClient.connect('ws://127.0.0.1:9000');

                setStatus('Connected');
                setButtonsEnabled(true);
                log('Connected!', 'log-success');
            } catch (e) {
                setStatus('Disconnected');
                setButtonsEnabled(false);
                log('Connection failed: ' + e, 'log-error');
            }
        };

        window.disconnect = function() {
            if (client) {
                client.close();
                client = null;
            }
            setStatus('Disconnected');
            setButtonsEnabled(false);
            log('Disconnected');
        };

        window.callAdder = async function() {
            if (!client) {
                log('Not connected', 'log-error');
                return;
            }

            const a = parseInt(document.getElementById('adderA').value);
            const b = parseInt(document.getElementById('adderB').value);

            try {
                log(`Calling add(${a}, ${b})...`);
                const result = await client.call_adder(a, b);
                log(`Result: ${a} + ${b} = ${result}`, 'log-success');
            } catch (e) {
                log('Error: ' + e, 'log-error');
            }
        };

        window.callRange = async function() {
            if (!client) {
                log('Not connected', 'log-error');
                return;
            }

            const n = parseInt(document.getElementById('rangeN').value);

            try {
                log(`Calling range(${n})...`);
                const stream = client.call_range(n);

                let count = 0;
                while (true) {
                    const value = await stream.next();
                    if (value === null) {
                        break;
                    }
                    log(`  Stream item ${count}: ${value}`, 'log-stream');
                    count++;
                }

                log(`Stream complete, received ${count} items`, 'log-success');
            } catch (e) {
                log('Error: ' + e, 'log-error');
            }
        };

        // Auto-init
        log('Page loaded. Click "Connect" to start.');
    </script>
</body>
</html>
